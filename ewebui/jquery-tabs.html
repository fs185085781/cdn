<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<script src="./asserts/boot/utils.js?from=pc&lib=jquery&env=test"></script>
	</head>
	<body>
	<div id="tabs" class="mini-tabs" activeIndex="0" style="width:100%;height:200px;margin-top:100px;margin-left:100px;" plain="false"
		 buttonsAlign="right"
	>
		<div title="Tab1" name="t1">
			1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />1<br />
		</div>
		<div title="Tab2" iconCls="icon-cut" name="t2">
			2
		</div>
		<div title="Tab3" showCloseButton="true" name="t3">
			3
		</div>
		<div title="Tab4" showCloseButton="true" name="t4" visible="false">
			4
		</div>
		<div title="Tab5" showCloseButton="true" name="t5">
			4
		</div>
	</div>
	</body>
	<script>
		mini.parse();
		var tabs = mini.get("tabs");
		openSaveTabsSort({
			tabs:tabs,
			get:function(){
				var defer = $.Deferred();
				defer.resolve("t3,t4,t1,t2,t5".split(","));
				return defer;
			},
			save:function(columns){
				console.log("保存:",columns)

			}
		});
		function openSaveTabsSort(options){
			var tabs = options.tabs;
			var lastColumnstr = "";
			var el = tabs.el;
			el.oncontextmenu=function(){return false;};
			el.onselectstart=function(){return false;};
			sortTabs();
			var targetMap;
			$(el).on("mousedown",".mini-tab",function(e){
				$("body").mousemove(function(e){
					if(targetMap && targetMap.drag){
						moveProxy(e);
					}
				});
				$("body").mouseup(function(e){
					if(targetMap && targetMap.drag){
						if(targetMap.needSort == 1 ||targetMap.needSort == 2){
							tabs.moveTab(targetMap.tab,targetMap.sortIndex);
							saveTabs();
						}
						$(targetMap.proxyData).remove();
						$(targetMap.topEl).remove();
						$(targetMap.bottomEl).remove();
						targetMap = undefined;
						$("body").off("mousemove");
						$("body").off("mouseup");
					}
				});
				if(!targetMap){
					targetMap = {};
				}
				var tab = tabs.getTab($(this).attr("index")*1);
				targetMap.drag = true;
				targetMap.needSort = 0;
				targetMap.tab = tab;
				var proxyData = mini.append(document.body, "<div class=\"mini-grid-columnproxy\"></div>");
				proxyData.innerHTML = "<div class=\"mini-grid-columnproxy-inner\" style=\"height:26px;\">" + tab.title + "</div>";
				targetMap.proxyData = proxyData;
				targetMap.topEl = mini.append(document.body, "<div class=\"mini-grid-movetop\" style='display:none;'></div>");
				targetMap.bottomEl = mini.append(document.body, "<div class=\"mini-grid-movebottom\" style='display:none;'></div>");
				var tabsz = tabs.getTabs();
				var otherTabs = [];
				$.each(tabsz,function(i,t){
					if(!t.name){
						mini.showTips({
							content: "当前标签控件存在标签页无name属性,请添加手重试",
							state: "danger",
							x: "center",
							y: "center"
						});
						return false;
					}
					if(t._id == tab._id){
						return true;
					}
					var pos = $("#"+tabs.uid+"\\$"+t._id).offset();
					if(!pos){
						return true;
					}
					var height = $("#"+tabs.uid+"\\$"+t._id)[0].clientHeight;
					var width = $("#"+tabs.uid+"\\$"+t._id)[0].clientWidth;
					otherTabs.push({tab:t,x1:pos.left,x2:pos.left+width,y1:pos.top,y2:pos.top+height});
				});
				targetMap.otherTabs = otherTabs;
				moveProxy(e);
			});
			function moveProxy(e){
				var x = e.clientX+14;
				var y = e.clientY+14;
				$(targetMap.proxyData).css({left:x+"px",top:y+"px"});
				var oldNeedSort = mini.clone(targetMap.needSort);
				targetMap.needSort = 0;
				var mx = 0;
				var my1 = 0;
				var my2 = 0;
				$.each(targetMap.otherTabs,function(i,tabMap){
					if(e.clientY<tabMap.y1 || e.clientY>tabMap.y2){
						return true;
					}
					my1 = tabMap.y1;
					my2 = tabMap.y2;
					if(e.clientX>tabMap.x1 && e.clientX<=tabMap.x1+(tabMap.x2-tabMap.x1)/2){
						targetMap.needSort = 1;
						targetMap.sortIndex = $("#"+tabs.uid+"\\$"+tabMap.tab._id).attr("index")*1;
						mx = tabMap.x1;
						return false;
					}else if(e.clientX>tabMap.x1+(tabMap.x2-tabMap.x1)/2 && e.clientX<=tabMap.x2){
						targetMap.needSort = 2;
						targetMap.sortIndex = $("#"+tabs.uid+"\\$"+tabMap.tab._id).attr("index")*1+1;
						mx = tabMap.x2;
						return false;
					}
				});
				if(oldNeedSort != targetMap.needSort){
					if(targetMap.needSort == 0){
						$(targetMap.topEl).hide();
						$(targetMap.bottomEl).hide();
					}else{
						mx += -5;
						$(targetMap.topEl).css({left:mx+"px",top:my1+"px"});
						$(targetMap.bottomEl).css({left:mx+"px",top:my2+"px"});
						$(targetMap.topEl).show();
						$(targetMap.bottomEl).show();
					}
				}

			}
			function sortTabs(){
				var defer = options.get();
				var tabsz = tabs.getTabs();
				var tabMap = {};
				$.each(tabsz,function(i,tab){
					tabMap[tab.name] = tab;
				});
				defer.done(function(list){
					lastColumnstr = list.join("-");
					$.each(list,function(i,name){
						var tab = tabMap[name];
						if(tab){
							tabs.moveTab(tab,i);
						}
					});
					tabs.reloadTab(tabs.getActiveTab());
				});
			}
			function saveTabs(){
				var tabsz = tabs.getTabs();
				var columns = [];
				$.each(tabsz,function(i,tab){
					if(!tab.name){
						mini.showTips({
							content: "当前标签控件存在标签页无name属性,无法保存此标签顺序",
							state: "danger",
							x: "center",
							y: "center"
						});
						return false;
					}
					columns.push(tab.name);
				});
				var columstr = columns.join("-");
				if(columstr == lastColumnstr){
					return;
				}
				lastColumnstr = columstr;
				options.save(columns);
			}
		}
	</script>
</html>
